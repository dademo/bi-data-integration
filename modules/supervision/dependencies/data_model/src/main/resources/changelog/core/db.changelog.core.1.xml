<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<!--
  ~ This Source Code Form is subject to the terms of the Mozilla Public
  ~ License, v. 2.0. If a copy of the MPL was not distributed with this
  ~ file, You can obtain one at https://mozilla.org/MPL/2.0/.
  -->
<databaseChangeLog
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">

    <changeSet id="1" author="dademo" dbms="postgresql,oracle,mssql">
        <comment>Used namespace</comment>
        <sql endDelimiter=";">
            CREATE SCHEMA ${schema_name}
        </sql>
    </changeSet>

    <changeSet author="dademo" id="2">
        <comment>Core table storing a backend state module execution</comment>

        <!-- fr.dademo.supervision.entities.DataBackendModuleMetaDataEntity -->
        <createTable tableName="data_backend_module_meta_data" schemaName="${schema_name}">
            <column name="id" type="INTEGER" autoIncrement="true">
                <constraints nullable="false" primaryKey="true" unique="true"/>
            </column>
            <column name="module_name" type="VARCHAR(255)">
                <constraints nullable="false" unique="false"/>
            </column>
            <column name="module_title" type="VARCHAR(255)">
                <constraints nullable="false" unique="false"/>
            </column>
            <column name="module_version" type="VARCHAR(50)">
                <constraints nullable="false" unique="false"/>
            </column>
            <column name="module_vendor" type="VARCHAR(255)">
                <constraints nullable="false" unique="false"/>
            </column>
        </createTable>
        <addUniqueConstraint
            constraintName="data_backend_module_meta_data_uniq"
            tableName="data_backend_module_meta_data"
            columnNames="module_name, module_title, module_version, module_vendor"
            schemaName="${schema_name}"
        />
        <createIndex tableName="data_backend_module_meta_data"
                     indexName="idx_data_backend_module_meta_data_modulename"
                     schemaName="${schema_name}">
            <column name="module_name" descending="true"/>
        </createIndex>
        <createIndex tableName="data_backend_module_meta_data"
                     indexName="idx_data_backend_module_meta_data_modulename_version"
                     schemaName="${schema_name}">
            <column name="module_name" descending="true"/>
            <column name="module_version" descending="true"/>
        </createIndex>
        <createIndex tableName="data_backend_module_meta_data"
                     indexName="idx_data_backend_module_meta_data_moduletitle"
                     schemaName="${schema_name}">
            <column name="module_title" descending="true"/>
        </createIndex>
        <createIndex tableName="data_backend_module_meta_data"
                     indexName="idx_data_backend_module_meta_data_moduletitle_version"
                     schemaName="${schema_name}">
            <column name="module_title" descending="true"/>
            <column name="module_version" descending="true"/>
        </createIndex>
        <createIndex tableName="data_backend_module_meta_data"
                     indexName="idx_data_backend_module_meta_data_modulevendor"
                     schemaName="${schema_name}">
            <column name="module_vendor" descending="true"/>
        </createIndex>

        <!-- fr.dademo.supervision.entities.DataBackendDescriptionEntity -->
        <createTable tableName="data_backend_description" schemaName="${schema_name}">
            <column name="id" type="INTEGER" autoIncrement="true">
                <constraints nullable="false" primaryKey="true" unique="true"/>
            </column>
            <column name="backend_product_name" type="VARCHAR(255)">
                <constraints nullable="false" unique="false"/>
            </column>
            <column name="backend_product_version" type="VARCHAR(50)">
                <constraints nullable="false" unique="false"/>
            </column>
            <column name="backend_name" type="VARCHAR(255)">
                <constraints nullable="true" unique="false"/>
            </column>
            <column name="start_time" type="DATETIME">
                <constraints nullable="true" unique="false"/>
            </column>
            <column name="primary_url" type="VARCHAR(1000)">
                <constraints nullable="true" unique="false"/>
            </column>
            <column name="backend_state" type="VARCHAR(10)">
                <constraints nullable="false" unique="false"/>
            </column>
            <column name="backend_state_explanation" type="CLOB">
                <constraints nullable="true" unique="false"/>
            </column>
            <column name="cluster_size" type="INTEGER">
                <constraints nullable="true" unique="false"/>
            </column>
            <column name="primary_count" type="INTEGER">
                <constraints nullable="true" unique="false"/>
            </column>
            <column name="replica_count" type="INTEGER">
                <constraints nullable="true" unique="false"/>
            </column>
            <column name="size_bytes" type="BIGINT">
                <constraints nullable="true" unique="false"/>
            </column>
            <column name="effective_size_bytes" type="BIGINT">
                <constraints nullable="true" unique="false"/>
            </column>
            <column name="available_size_bytes" type="BIGINT">
                <constraints nullable="true" unique="false"/>
            </column>
        </createTable>
        <addUniqueConstraint
            constraintName="data_backend_description_uniq"
            tableName="data_backend_description"
            columnNames="primary_url, start_time, backend_name, backend_product_name, backend_product_version, backend_state, backend_state_explanation"
            schemaName="${schema_name}"
        />
        <createIndex tableName="data_backend_description"
                     indexName="idx_data_backend_description_backend_product_name"
                     schemaName="${schema_name}">
            <column name="backend_product_name" descending="true"/>
        </createIndex>
        <createIndex tableName="data_backend_description"
                     indexName="idx_data_backend_description_backend_product_name_version"
                     schemaName="${schema_name}">
            <column name="backend_product_name" descending="true"/>
            <column name="backend_product_version" descending="true"/>
        </createIndex>
        <createIndex tableName="data_backend_description"
                     indexName="idx_data_backend_description_backend_name"
                     schemaName="${schema_name}">
            <column name="backend_name" descending="true"/>
        </createIndex>
        <createIndex tableName="data_backend_description"
                     indexName="idx_data_backend_description_start_time"
                     schemaName="${schema_name}">
            <column name="start_time" descending="true"/>
        </createIndex>
        <createIndex tableName="data_backend_description"
                     indexName="idx_data_backend_description_primary_url"
                     schemaName="${schema_name}">
            <column name="primary_url" descending="true"/>
        </createIndex>
        <createIndex tableName="data_backend_description"
                     indexName="idx_data_backend_description_backend_state"
                     schemaName="${schema_name}">
            <column name="backend_state" descending="true"/>
        </createIndex>

        <!-- fr.dademo.supervision.entities.DataBackendStateExecutionEntity -->
        <createTable tableName="data_backend_state_execution" schemaName="${schema_name}">
            <column name="id" type="INTEGER" autoIncrement="true">
                <constraints nullable="false" primaryKey="true" unique="true"/>
            </column>
            <column name="id_backend_module_meta_data" type="INTEGER">
                <constraints
                    nullable="false" unique="false"
                    foreignKeyName="fk_data_backend_state_execution__data_backend_module_meta_data_id"
                    referencedTableSchemaName="${schema_name}"
                    referencedTableName="data_backend_module_meta_data"
                    referencedColumnNames="id"
                />
            </column>
            <column name="id_backend_description" type="INTEGER">
                <constraints
                    nullable="false" unique="false"
                    foreignKeyName="fk_data_backend_state_execution__data_backend_description_id"
                    referencedTableSchemaName="${schema_name}"
                    referencedTableName="data_backend_description"
                    referencedColumnNames="id"
                />
            </column>
            <column name="execution" type="DATETIME">
                <constraints nullable="false" unique="false"/>
            </column>
        </createTable>

        <!-- fr.dademo.supervision.entities.DataBackendClusterNodeEntity -->
        <createTable tableName="data_backend_cluster_node" schemaName="${schema_name}">
            <column name="id" type="INTEGER" autoIncrement="true">
                <constraints nullable="false" primaryKey="true" unique="true"/>
            </column>
            <column name="id_data_backend_description" type="INTEGER">
                <constraints
                    nullable="false" unique="false"
                    foreignKeyName="fk_data_backend_cluster_node__data_backend_description_id"
                    referencedTableSchemaName="${schema_name}"
                    referencedTableName="data_backend_description"
                    referencedColumnNames="id"
                />
            </column>
            <column name="url" type="VARCHAR(1000)">
                <constraints nullable="false" unique="false"/>
            </column>
            <column name="role" type="VARCHAR(255)">
                <constraints nullable="true" unique="false"/>
            </column>
        </createTable>
        <createIndex tableName="data_backend_cluster_node"
                     indexName="idx_data_backend_cluster_node_url"
                     schemaName="${schema_name}">
            <column name="url" descending="true"/>
        </createIndex>
        <createIndex tableName="data_backend_cluster_node"
                     indexName="idx_data_backend_cluster_node_role"
                     schemaName="${schema_name}">
            <column name="role" descending="true"/>
        </createIndex>

        <createTable tableName="data_backend_cluster_node__state_execution" schemaName="${schema_name}">
            <column name="id_data_backend_cluster_node" type="INTEGER">
                <constraints
                    nullable="false" unique="false"
                    foreignKeyName="fk_data_backend_cluster_node__state_execution__cluster_node_id"
                    referencedTableSchemaName="${schema_name}"
                    referencedTableName="data_backend_cluster_node"
                    referencedColumnNames="id"
                />
            </column>
            <column name="id_backend_state_execution" type="INTEGER">
                <constraints
                    nullable="false" unique="false"
                    foreignKeyName="fk_data_backend_cluster_node__state_execution__backend_state_execution_id"
                    referencedTableSchemaName="${schema_name}"
                    referencedTableName="data_backend_state_execution"
                    referencedColumnNames="id"
                />
            </column>
        </createTable>
        <createIndex tableName="data_backend_cluster_node__state_execution"
                     indexName="idx_data_backend_cluster_node__state_execution__uniq"
                     schemaName="${schema_name}"
                     unique="true">
            <column name="id_data_backend_cluster_node" descending="true"/>
            <column name="id_backend_state_execution" descending="true"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>